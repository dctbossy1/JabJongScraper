<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>JabJong ‚Äì Mini Form (LIFF)</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      :root {
        --brand: #ffbd01; /* main brand yellow */
        --text: #111;
        --muted: #666;
        --bg: #fff;
        --line: #eee;
        --ok: #0f893b;
        --danger: #c62828;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(17, 17, 17, 0.06);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial;
        color: var(--text);
        background: var(--bg);
      }
      .wrap {
        max-width: 520px;
        margin: 0 auto;
        padding: 16px 16px 96px;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: saturate(150%) blur(6px);
        border-bottom: 1px solid var(--line);
      }
      .head {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
      }
      .logo {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--brand);
        display: grid;
        place-items: center;
        font-weight: 800;
      }
      h1 {
        font-size: 18px;
        margin: 0;
      }
      .help {
        font-size: 12px;
        color: var(--muted);
      }

      .card {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 14px;
        margin: 16px 0;
      }
      .card h2 {
        font-size: 16px;
        margin: 0 0 8px;
      }

      label {
        display: block;
        font-weight: 600;
        margin: 10px 0 6px;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        font-size: 15px;
        background: #fff;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        padding: 8px 12px;
        border: 1px solid var(--line);
        border-radius: 999px;
        cursor: pointer;
        user-select: none;
        font-size: 14px;
      }
      .chip.is-on {
        background: var(--brand);
      }

      .inline {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn {
        appearance: none;
        border: none;
        cursor: pointer;
        border-radius: 12px;
        padding: 12px 14px;
        font-weight: 700;
        box-shadow: var(--shadow);
      }
      .btn.brand {
        background: var(--brand);
      }
      .btn.ghost {
        background: #fff;
        border: 1px solid var(--line);
      }
      .btn.full {
        width: 100%;
      }
      .btn.small {
        padding: 8px 10px;
        font-weight: 600;
      }

      .switch {
        position: relative;
        width: 46px;
        height: 28px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        inset: 0;
        background: #ddd;
        border-radius: 999px;
        transition: 0.2s;
      }
      .slider:before {
        content: "";
        position: absolute;
        height: 22px;
        width: 22px;
        left: 3px;
        top: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.2s;
      }
      .switch input:checked + .slider {
        background: var(--brand);
      }
      .switch input:checked + .slider:before {
        transform: translateX(18px);
      }

      .sticky {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 12px 16px;
        z-index: 10;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: saturate(150%) blur(6px);
        border-top: 1px solid var(--line);
      }
      .summary {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
        font-feature-settings: "tnum" 1, "case" 1;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }
      .danger {
        color: var(--danger);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="head">
        <div class="logo">
          <img src="./images/logo.png" alt="Logo" class="logo" />
        </div>
        <div>
          <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h1>
          <div class="help">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</div>
        </div>
      </div>
    </header>

    <main class="wrap">
      <!-- STEP 1: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å -->
      <section class="card" id="sec-type">
        <h2>‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£</h2>
        <div class="row">
          <button class="btn ghost" type="button" data-kind="restaurant">
            üçΩÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£
          </button>
          <button class="btn ghost" type="button" data-kind="hotel">
            üõèÔ∏è ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
          </button>
        </div>
        <div id="type-restaurant" style="margin-top: 12px">
          <label for="cuisineInput">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)</label>
          <input
            id="cuisineInput"
            type="text"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à, ‡∏õ‡∏¥‡πâ‡∏á‡∏¢‡πà‡∏≤‡∏á, ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏Å‡∏≤‡πÅ‡∏ü"
            list="cuisineList"
          />
          <datalist id="cuisineList"></datalist>
          <div class="chips" id="cuisineChips" style="margin-top: 10px"></div>
          <div class="hint">
            ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å / ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter
          </div>
        </div>
        <div id="type-hotel" style="display: none; margin-top: 12px">
          <label for="hotelType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</label>
          <select id="hotelType">
            <option value="any">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
            <option value="hotel">Hotel</option>
            <option value="hostel">Hostel</option>
            <option value="resort">Resort</option>
            <option value="guest_house">Guest House</option>
            <option value="villa">Villa</option>
            <option value="bnb">B&B</option>
          </select>
        </div>
      </section>

      <!-- STEP 2: ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà / ‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô -->
      <section class="card" id="sec-location">
        <h2>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>
        <label for="locationText">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡∏ô‡∏ô/‡πÄ‡∏Ç‡∏ï/‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å)</label>
        <input
          id="locationText"
          type="text"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô, ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ó‡πà‡∏≤‡πÅ‡∏û, ‡∏™‡∏¢‡∏≤‡∏°"
        />

        <div class="row" style="margin-top: 10px">
          <button id="btnGeo" class="btn ghost" type="button">
            üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          </button>
        </div>
        <div id="geoOut" class="hint"></div>

        <label style="margin-top: 12px"
          >‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à <span id="radiusKm" class="mono">2</span> ‡∏Å‡∏°.</label
        >
        <input
          id="radius"
          type="range"
          min="1"
          max="25"
          value="2"
          step="1"
          style="width: 100%"
        />
      </section>

      <!-- STEP 3: ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì / ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç -->
      <section class="card" id="sec-filters">
        <h2>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì & ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</h2>
        <div class="row">
          <div>
            <label for="priceMin">‡∏á‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (‡∏ö‡∏≤‡∏ó)</label>
            <input id="priceMin" type="number" min="0" placeholder="0" />
          </div>
          <div>
            <label for="priceMax">‡∏á‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ö‡∏≤‡∏ó)</label>
            <input id="priceMax" type="number" min="0" placeholder="500" />
          </div>
        </div>
        <div class="inline" style="margin-top: 12px">
          <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
          <label class="switch">
            <input id="openNow" type="checkbox" />
            <span class="slider"></span>
          </label>
        </div>
      </section>

      <!-- STEP 4: ‡∏†‡∏≤‡∏©‡∏≤ -->
      <section class="card" id="sec-lang">
        <h2>‡∏†‡∏≤‡∏©‡∏≤</h2>
        <select id="lang">
          <option value="th">‡πÑ‡∏ó‡∏¢</option>
          <option value="en">English</option>
          <option value="zh-CN">‰∏≠Êñá(ÁÆÄ‰Ωì)</option>
          <option value="ja">Êó•Êú¨Ë™û</option>
          <option value="ko">ÌïúÍµ≠Ïñ¥</option>
        </select>
        <div class="hint">‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å LIFF/‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
      </section>

      <!-- STEP 5: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
      <section class="card" id="sec-note">
        <h2>‡∏ö‡∏≠‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h2>
        <textarea
          id="note"
          rows="3"
          placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ, ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ, ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î"
        ></textarea>
      </section>

      <div class="sticky">
        <div class="summary" id="summary">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ üëç</div>
        <button id="btnSubmit" class="btn brand full" type="button">
          üîé ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        </button>
      </div>
    </main>

    <script>
      // =============== CONFIG ===============
      const LIFF_ID = "2008021094-3eKlOOb7";
      const WEBHOOK_URL = "https://primary-production-b2936.up.railway.app/webhook-test/jab-jong";

      // ‡∏ä‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
      const CUISINE_PRESETS = [
        "‡πÄ‡∏à",
        "‡∏°‡∏±‡∏á‡∏™‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏¥",
        "‡∏õ‡∏¥‡πâ‡∏á‡∏¢‡πà‡∏≤‡∏á",
        "‡∏ä‡∏≤‡∏ö‡∏π",
        "‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà‡∏ï‡πå",
        "‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á",
        "‡∏≠‡∏µ‡∏™‡∏≤‡∏ô",
        "‡πÄ‡∏´‡∏ô‡∏∑‡∏≠",
        "‡πÑ‡∏ó‡∏¢",
        "‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î",
        "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô",
        "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ",
        "‡∏à‡∏µ‡∏ô",
        "‡∏Æ‡∏≤‡∏•‡∏≤‡∏•",
        "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°",
        "‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢",
        "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß",
        "‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤",
        "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô",
        "‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà",
        "‡∏Å‡∏≤‡πÅ‡∏ü",
        "‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà",
      ];

      // =============== STATE ===============
      const state = {
        kind: "restaurant", // "restaurant" | "hotel"
        cuisines: new Set(),
        hotelType: "any",
        lat: null,
        lng: null,
        locationText: "",
        radiusKm: 2,
        priceMin: null,
        priceMax: null,
        openNow: false,
        lang: "th",
        note: "",
        userId: null,
      };

      // =============== DOM ===============
      const $ = (sel, p = document) => p.querySelector(sel);
      const $$ = (sel, p = document) => [...p.querySelectorAll(sel)];

      const btnsKind = $$("[data-kind]");
      const cuisineInput = $("#cuisineInput");
      const cuisineList = $("#cuisineList");
      const cuisineChips = $("#cuisineChips");
      const hotelType = $("#hotelType");

      const locationText = $("#locationText");
      const btnGeo = $("#btnGeo");
      const geoOut = $("#geoOut");

      const radius = $("#radius");
      const radiusKm = $("#radiusKm");

      const priceMin = $("#priceMin");
      const priceMax = $("#priceMax");
      const openNow = $("#openNow");

      const langSel = $("#lang");
      const note = $("#note");

      const summary = $("#summary");
      const btnSubmit = $("#btnSubmit");

      // =============== INIT UI ===============
      function renderCuisineList() {
        cuisineList.innerHTML = CUISINE_PRESETS.map(
          (x) => `<option value="${x}"></option>`
        ).join("");
      }
      function renderCuisineChips() {
        const chips = [...state.cuisines];
        cuisineChips.innerHTML = chips.length
          ? chips
              .map(
                (x) => `<span class="chip is-on" data-chip="${x}">${x} ‚úï</span>`
              )
              .join("")
          : `<span class="help">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>`;
      }
      function setKind(k) {
        state.kind = k;
        btnsKind.forEach((b) =>
          b.classList.toggle("brand", b.dataset.kind === k)
        );
        $("#type-restaurant").style.display =
          k === "restaurant" ? "block" : "none";
        $("#type-hotel").style.display = k === "hotel" ? "block" : "none";
        updateSummary();
      }

      // =============== HANDLERS ===============
      btnsKind.forEach((b) =>
        b.addEventListener("click", () => setKind(b.dataset.kind))
      );

      cuisineInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const v = cuisineInput.value.trim();
          if (v) {
            state.cuisines.add(v);
            cuisineInput.value = "";
            renderCuisineChips();
            updateSummary();
          }
        }
      });
      cuisineChips.addEventListener("click", (e) => {
        const t = e.target.closest("[data-chip]");
        if (!t) return;
        state.cuisines.delete(t.dataset.chip);
        renderCuisineChips();
        updateSummary();
      });

      hotelType.addEventListener("change", () => {
        state.hotelType = hotelType.value;
        updateSummary();
      });

      locationText.addEventListener("input", () => {
        state.locationText = locationText.value.trim();
        updateSummary();
      });

      radius.addEventListener("input", () => {
        state.radiusKm = +radius.value;
        radiusKm.textContent = state.radiusKm;
        updateSummary();
      });

      priceMin.addEventListener("input", () => {
        state.priceMin = priceMin.value ? +priceMin.value : null;
        updateSummary();
      });
      priceMax.addEventListener("input", () => {
        state.priceMax = priceMax.value ? +priceMax.value : null;
        updateSummary();
      });
      openNow.addEventListener("change", () => {
        state.openNow = !!openNow.checked;
        updateSummary();
      });

      langSel.addEventListener("change", () => {
        state.lang = langSel.value;
        updateSummary();
      });
      note.addEventListener("input", () => {
        state.note = note.value.trim();
        updateSummary();
      });

      btnGeo.addEventListener("click", () => {
        if (!navigator.geolocation) {
          geoOut.innerHTML = `<span class="danger">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation</span>`;
          return;
        }
        geoOut.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶";
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            state.lat = +latitude.toFixed(6);
            state.lng = +longitude.toFixed(6);
            geoOut.innerHTML = `‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î: <span class="pill mono">${state.lat}, ${state.lng}</span>`;
            updateSummary();
          },
          (err) => {
            geoOut.innerHTML = `<span class="danger">‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</span>`;
          },
          { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
      });

      function updateSummary() {
        const parts = [];
        parts.push(
          state.kind === "restaurant"
            ? `‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£`
            : `‡∏´‡∏≤${labelHotel(state.hotelType)}`
        );
        const cs = [...state.cuisines];
        if (cs.length) parts.push(`‡∏´‡∏°‡∏ß‡∏î: ${cs.join(", ")}`);
        if (state.locationText) parts.push(`‡πÅ‡∏ñ‡∏ß: ${state.locationText}`);
        if (state.lat && state.lng) parts.push(`@(${state.lat},${state.lng})`);
        parts.push(`‡∏£‡∏±‡∏®‡∏°‡∏µ ${state.radiusKm} ‡∏Å‡∏°.`);
        if (state.priceMin != null || state.priceMax != null) {
          parts.push(`‡∏á‡∏ö: ${state.priceMin ?? 0}-${state.priceMax ?? "‚àû"}‡∏ø`);
        }
        if (state.openNow) parts.push(`‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ`);
        parts.push(`‡∏†‡∏≤‡∏©‡∏≤: ${state.lang}`);
        summary.textContent = parts.join(" ‚Ä¢ ");
        btnSubmit.disabled = !isFormValid();
      }

      function labelHotel(v) {
        switch (v) {
          case "hotel":
            return "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°";
          case "hostel":
            return "‡πÇ‡∏Æ‡∏™‡πÄ‡∏ó‡∏•";
          case "resort":
            return "‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó";
          case "guest_house":
            return "‡πÄ‡∏Å‡∏™‡∏ï‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå";
          case "villa":
            return "‡∏ß‡∏¥‡∏•‡∏•‡πà‡∏≤";
          case "bnb":
            return "‡∏ö‡∏µ‡πÅ‡∏≠‡∏ô‡∏î‡πå‡∏ö‡∏µ";
          default:
            return "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å";
        }
      }

      function payload() {
        return {
          kind: state.kind,
          cuisines: [...state.cuisines],
          hotelType: state.hotelType,
          locationText: state.locationText || null,
          lat: state.lat,
          lng: state.lng,
          radiusKm: state.radiusKm,
          budget: { min: state.priceMin, max: state.priceMax },
          openNow: state.openNow,
          lang: state.lang,
          note: state.note || null,
          userId: state.userId,
          source: "liff-mini-form",
          ts: new Date().toISOString(),
        };
      }

      function isFormValid() {
        if (state.kind === "restaurant") {
          return (
            state.cuisines.size > 0 ||
            state.locationText ||
            (state.lat && state.lng)
          );
        }
        if (state.kind === "hotel") {
          return (
            state.hotelType !== "any" &&
            (state.locationText || (state.lat && state.lng))
          );
        }
        return false;
      }

      async function submit() {
        const data = payload();
        if (WEBHOOK_URL) {
          try {
            const r = await fetch(WEBHOOK_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            notify("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÄ‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ‚ú®");
            closeLiff();
            return;
          } catch (err) {
            notify(`‡∏™‡πà‡∏á‡πÑ‡∏õ backend ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
          }
        }
        try {
          if (window.liff && liff.isInClient()) {
            await liff.sendMessages([
              { type: "text", text: `JabJong: ${summary.textContent}` },
              { type: "text", text: JSON.stringify(data) },
            ]);
            notify("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
            closeLiff();
          } else {
            alert("DEV Preview:\\n" + JSON.stringify(data, null, 2));
          }
        } catch (err) {
          notify(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
        }
      }

      function notify(msg) {
        summary.textContent = msg;
      }
      function closeLiff() {
        try {
          if (liff.isInClient()) liff.closeWindow();
        } catch {}
      }

      btnSubmit.addEventListener("click", submit);

      // =============== LIFF INIT ===============
      (async function init() {
        try {
          if (window.liff) {
            await liff.init({ liffId: LIFF_ID });
            if (liff.getLanguage) {
              const lang = (liff.getLanguage() || "th").toLowerCase();
              const m = {
                th: "th",
                en: "en",
                "zh-cn": "zh-CN",
                ja: "ja",
                ko: "ko",
              };
              state.lang = m[lang] || "th";
              langSel.value = state.lang;
            }
            if (liff.isLoggedIn && !liff.isLoggedIn()) liff.login();
            try {
              const prof = await liff.getProfile();
              state.userId = prof?.userId || null;
            } catch {}
          }
        } catch (err) {
          console.warn("LIFF init error", err);
        } finally {
          setKind(state.kind);
          renderCuisineList();
          renderCuisineChips();
          updateSummary();
        }
      })();
    </script>
  </body>
</html>
