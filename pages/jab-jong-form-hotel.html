<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>JabJong ‚Äì Mini Form (Hotels ‚Äì Reviews Only)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --brand:#FFBD01;
      --text:#111;
      --muted:#666;
      --bg:#fff;
      --line:#eee;
      --ok:#0f893b;
      --danger:#c62828;
      --radius:16px;
      --shadow:0 8px 24px rgba(17,17,17,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text); background:var(--bg);
    }
    .wrap{max-width:520px; margin:0 auto; padding:16px 16px 96px}
    header{position:sticky; top:0; z-index:5; background:rgba(255,255,255,.9); backdrop-filter:saturate(150%) blur(6px); border-bottom:1px solid var(--line)}
    .head{display:flex; align-items:center; gap:12px; padding:12px 16px}
    .logo{width:36px; height:36px; border-radius:50%; background:var(--brand); display:grid; place-items:center; font-weight:800}
    h1{font-size:18px; margin:0}
    .help{font-size:12px; color:var(--muted)}

    .card{background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin:16px 0}
    .card h2{font-size:16px; margin:0 0 8px}

    label{display:block; font-weight:600; margin:10px 0 6px}
    input[type="text"], select, textarea{
      width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; font-size:15px; background:#fff;
    }
    input:disabled, select:disabled { background:#f6f6f6; color:#999; }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .inline{display:flex; align-items:center; gap:10px}
    .btn{appearance:none; border:none; cursor:pointer; border-radius:12px; padding:12px 14px; font-weight:700; box-shadow:var(--shadow);}
    .btn.brand{background:var(--brand)}
    .btn.ghost{background:#fff; border:1px solid var(--line)}
    .btn.full{width:100%}
    .btn.small{padding:8px 10px; font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed; box-shadow:none}

    .sticky{
      position:fixed; left:0; right:0; bottom:0; padding:12px 16px; z-index:10;
      background:rgba(255,255,255,.98); backdrop-filter:saturate(150%) blur(6px);
      border-top:1px solid var(--line);
    }
    .summary{font-size:12px; color:var(--muted); margin-bottom:8px}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--line); border-radius:999px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-feature-settings: "tnum" 1, "case" 1}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .danger{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="logo"><img src="./images/logo.png" alt="Logo" class="logo"></div>
      <div>
        <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h1>
        <div class="help">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å + ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HOTEL TYPE -->
    <section class="card" id="sec-type">
      <h2>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å</h2>
      <select id="hotelType">
        <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‚Äî</option>
        <option value="hotel">Hotel</option>
        <option value="hostel">Hostel</option>
        <option value="resort">Resort</option>
        <option value="guest_house">Guest House</option>
        <option value="villa">Villa</option>
        <option value="bnb">B&B</option>
        <option value="lodging">Lodging (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
      </select>
    </section>

    <!-- LOCATION -->
    <section class="card" id="sec-location">
      <h2>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h2>
      <label for="locationText">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡∏ô‡∏ô/‡πÄ‡∏Ç‡∏ï/‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å)</label>
      <input id="locationText" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô, ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ó‡πà‡∏≤‡πÅ‡∏û, ‡∏™‡∏¢‡∏≤‡∏°" />

      <div class="row" style="margin-top:10px">
        <button id="btnGeo" class="btn ghost" type="button">üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
        <button id="btnClearGeo" class="btn ghost" type="button" style="display:none">‚úñÔ∏è ‡∏•‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
      </div>
      <div id="geoOut" class="hint"></div>

      <label style="margin-top:12px">‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à <span id="radiusKm" class="mono">2</span> ‡∏Å‡∏°.</label>
      <input id="radius" type="range" min="1" max="25" value="2" step="1" style="width:100%" />
    </section>

    <!-- NOTE -->
    <section class="card" id="sec-note">
      <h2>‡∏ö‡∏≠‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h2>
      <textarea id="note" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏Å‡∏•‡πâ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏™‡∏á‡∏ö, ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ"></textarea>
    </section>

    <div class="sticky">
      <div class="summary" id="summary">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div>
      <button id="btnSubmit" class="btn brand full" type="button" disabled>üîé ‡∏î‡∏∂‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
    </div>
  </main>

  <script>
    // =============== CONFIG ===============
    const LIFF_ID = "2008021094-3eKlOOb7";
    const WEBHOOK_URL = "https://primary-production-b2936.up.railway.app/webhook-test/jab-jong";

    // =============== STATE ===============
    const state = {
      kind: "hotel",
      hotelType: "",
      lat: null, lng: null, locationText: "",
      radiusKm: 2,
      note: "",
      userId: null,
    };

    // =============== DOM ===============
    const $ = (sel, p=document) => p.querySelector(sel);

    const hotelType   = $("#hotelType");
    const locationText= $("#locationText");
    const btnGeo      = $("#btnGeo");
    const btnClearGeo = $("#btnClearGeo");
    const geoOut      = $("#geoOut");

    const radius      = $("#radius");
    const radiusKm    = $("#radiusKm");

    const note        = $("#note");

    const summary     = $("#summary");
    const btnSubmit   = $("#btnSubmit");

    // =============== HANDLERS ===============
    hotelType.addEventListener("change", () => { state.hotelType = hotelType.value; updateSummary(); });
    locationText.addEventListener("input", () => { state.locationText = locationText.value.trim(); syncLocationControls(); updateSummary(); });
    radius.addEventListener("input", () => { state.radiusKm = +radius.value; radiusKm.textContent = state.radiusKm; updateSummary(); });
    note.addEventListener("input", () => { state.note = note.value.trim(); updateSummary(); });

    btnGeo.addEventListener("click", () => {
      if (!navigator.geolocation){ geoOut.innerHTML = `<span class="danger">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation</span>`; return; }
      geoOut.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Ä¶";
      navigator.geolocation.getCurrentPosition((pos) => {
        const {latitude, longitude} = pos.coords;
        state.lat = +latitude.toFixed(6); state.lng = +longitude.toFixed(6);
        geoOut.innerHTML = `‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î: <span class="pill mono">${state.lat}, ${state.lng}</span>`;
        syncLocationControls();
        updateSummary();
      }, (err) => {
        geoOut.innerHTML = `<span class="danger">‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</span>`;
      }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    });

    btnClearGeo.addEventListener("click", () => {
      state.lat = null; state.lng = null;
      geoOut.innerHTML = "";
      syncLocationControls();
      updateSummary();
    });

    function syncLocationControls(){
      const hasGeo = !!(state.lat && state.lng);
      const hasText = !!state.locationText;
      if (hasGeo) {
        locationText.value = "";
        locationText.disabled = true;
        btnGeo.disabled = true;
        btnClearGeo.style.display = "inline-flex";
        if (!geoOut.innerHTML) {
          geoOut.innerHTML = `‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î: <span class="pill mono">${state.lat}, ${state.lng}</span>`;
        }
      } else {
        locationText.disabled = false;
        btnClearGeo.style.display = "none";
        btnGeo.disabled = hasText;
        if (!hasText) geoOut.innerHTML = "";
      }
    }

    function isFormValid(){
      return !!(
        state.hotelType &&
        (state.locationText || (state.lat && state.lng))
      );
    }

    function labelHotel(v){
      switch(v){
        case "hotel": return "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°";
        case "hostel": return "‡πÇ‡∏Æ‡∏™‡πÄ‡∏ó‡∏•";
        case "resort": return "‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ï";
        case "guest_house": return "‡πÄ‡∏Å‡∏™‡∏ï‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå";
        case "villa": return "‡∏ß‡∏¥‡∏•‡∏•‡πà‡∏≤";
        case "bnb": return "‡∏ö‡∏µ‡πÅ‡∏≠‡∏ô‡∏î‡πå‡∏ö‡∏µ";
        case "lodging": return "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)";
        default: return "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å";
      }
    }

    function updateSummary(){
      const parts = [];
      parts.push(`‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å: ${labelHotel(state.hotelType) || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î"}`);
      if (state.locationText) parts.push(`‡πÅ‡∏ñ‡∏ß: ${state.locationText}`);
      if (state.lat && state.lng) parts.push(`@(${state.lat},${state.lng})`);
      parts.push(`‡∏£‡∏±‡∏®‡∏°‡∏µ ${state.radiusKm} ‡∏Å‡∏°.`);
      if (state.note) parts.push(`‡πÇ‡∏ô‡πâ‡∏ï: ${state.note}`);
      summary.textContent = parts.join(" ‚Ä¢ ");
      btnSubmit.disabled = !isFormValid();
    }

    function payload(){
      return {
        kind: "hotel",
        hotelType: state.hotelType,
        locationText: state.locationText || null,
        lat: state.lat, lng: state.lng,
        radiusKm: state.radiusKm,
        note: state.note || null,
        userId: state.userId,
        source: "liff-mini-form",
        ts: new Date().toISOString(),
        want: "reviews_only"
      };
    }

    async function submit(){
      const data = payload();
      if (WEBHOOK_URL){
        try{
          const r = await fetch(WEBHOOK_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          notify("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì ‚ú®");
          closeLiff();
          return;
        }catch(err){
          notify(`‡∏™‡πà‡∏á‡πÑ‡∏õ backend ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`);
        }
      }
      try{
        if (window.liff && liff.isInClient()){
          await liff.sendMessages([{ type:'text', text: `JabJong: ${summary.textContent}` }, { type:'text', text: JSON.stringify(data) }]);
          notify("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
          closeLiff();
        }else{
          alert("DEV Preview:\\n"+ JSON.stringify(data, null, 2));
        }
      }catch(err){ notify(`‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}`); }
    }

    function notify(msg){ summary.textContent = msg; }
    function closeLiff(){ try{ if (liff.isInClient()) liff.closeWindow(); }catch{} }

    btnSubmit.addEventListener("click", submit);

    // =============== LIFF INIT ===============
    (async function init(){
      try{
        if (window.liff){
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn && !liff.isLoggedIn()) liff.login();
          try{
            const prof = await liff.getProfile();
            state.userId = prof?.userId || null;
          }catch{}
        }
      }catch(err){
        console.warn('LIFF init error', err);
      }finally{
        syncLocationControls();
        updateSummary();
      }
    })();
  </script>
</body>
</html>
